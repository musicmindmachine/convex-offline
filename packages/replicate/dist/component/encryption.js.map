{"version":3,"file":"encryption.js","names":[],"sources":["../../src/component/encryption.ts"],"sourcesContent":["import { mutation, query } from \"./_generated/server\";\nimport { v } from \"convex/values\";\n\nexport const registerDevice = mutation({\n\targs: {\n\t\tcollection: v.string(),\n\t\tuserId: v.string(),\n\t\tdeviceId: v.string(),\n\t\tpublicKey: v.bytes(),\n\t\tname: v.optional(v.string()),\n\t},\n\thandler: async (ctx, args) => {\n\t\tconst existing = await ctx.db\n\t\t\t.query(\"devices\")\n\t\t\t.withIndex(\"by_device\", q =>\n\t\t\t\tq.eq(\"collection\", args.collection).eq(\"userId\", args.userId).eq(\"deviceId\", args.deviceId),\n\t\t\t)\n\t\t\t.first();\n\n\t\tif (existing) {\n\t\t\tawait ctx.db.patch(existing._id, {\n\t\t\t\tpublicKey: args.publicKey,\n\t\t\t\tlastSeen: Date.now(),\n\t\t\t\tname: args.name,\n\t\t\t});\n\t\t\treturn { id: existing._id, isNew: false };\n\t\t}\n\n\t\tconst userDevices = await ctx.db\n\t\t\t.query(\"devices\")\n\t\t\t.withIndex(\"by_user\", q => q.eq(\"collection\", args.collection).eq(\"userId\", args.userId))\n\t\t\t.collect();\n\n\t\tconst isFirstDevice = userDevices.length === 0;\n\n\t\tconst id = await ctx.db.insert(\"devices\", {\n\t\t\tcollection: args.collection,\n\t\t\tuserId: args.userId,\n\t\t\tdeviceId: args.deviceId,\n\t\t\tpublicKey: args.publicKey,\n\t\t\tname: args.name,\n\t\t\tcreated: Date.now(),\n\t\t\tlastSeen: Date.now(),\n\t\t\tapproved: isFirstDevice,\n\t\t});\n\n\t\treturn { id, isNew: true, autoApproved: isFirstDevice };\n\t},\n});\n\nexport const listDevices = query({\n\targs: {\n\t\tcollection: v.string(),\n\t\tuserId: v.string(),\n\t},\n\thandler: async (ctx, args) => {\n\t\treturn ctx.db\n\t\t\t.query(\"devices\")\n\t\t\t.withIndex(\"by_user\", q => q.eq(\"collection\", args.collection).eq(\"userId\", args.userId))\n\t\t\t.collect();\n\t},\n});\n\nexport const getPendingDevices = query({\n\targs: {\n\t\tcollection: v.string(),\n\t\tuserId: v.string(),\n\t},\n\thandler: async (ctx, args) => {\n\t\tconst devices = await ctx.db\n\t\t\t.query(\"devices\")\n\t\t\t.withIndex(\"by_user\", q => q.eq(\"collection\", args.collection).eq(\"userId\", args.userId))\n\t\t\t.collect();\n\n\t\treturn devices.filter(d => !d.approved);\n\t},\n});\n\nexport const approveDevice = mutation({\n\targs: {\n\t\tcollection: v.string(),\n\t\tuserId: v.string(),\n\t\tdeviceId: v.string(),\n\t\twrappedUmk: v.bytes(),\n\t},\n\thandler: async (ctx, args) => {\n\t\tconst device = await ctx.db\n\t\t\t.query(\"devices\")\n\t\t\t.withIndex(\"by_device\", q =>\n\t\t\t\tq.eq(\"collection\", args.collection).eq(\"userId\", args.userId).eq(\"deviceId\", args.deviceId),\n\t\t\t)\n\t\t\t.first();\n\n\t\tif (!device) {\n\t\t\tthrow new Error(\"Device not found\");\n\t\t}\n\n\t\tawait ctx.db.patch(device._id, { approved: true });\n\n\t\tconst existingKey = await ctx.db\n\t\t\t.query(\"wrappedKeys\")\n\t\t\t.withIndex(\"by_device\", q =>\n\t\t\t\tq.eq(\"collection\", args.collection).eq(\"userId\", args.userId).eq(\"deviceId\", args.deviceId),\n\t\t\t)\n\t\t\t.first();\n\n\t\tif (existingKey) {\n\t\t\tawait ctx.db.patch(existingKey._id, { wrappedUmk: args.wrappedUmk });\n\t\t} else {\n\t\t\tawait ctx.db.insert(\"wrappedKeys\", {\n\t\t\t\tcollection: args.collection,\n\t\t\t\tuserId: args.userId,\n\t\t\t\tdeviceId: args.deviceId,\n\t\t\t\twrappedUmk: args.wrappedUmk,\n\t\t\t\tcreated: Date.now(),\n\t\t\t});\n\t\t}\n\n\t\treturn { success: true };\n\t},\n});\n\nexport const getWrappedUmk = query({\n\targs: {\n\t\tcollection: v.string(),\n\t\tuserId: v.string(),\n\t\tdeviceId: v.string(),\n\t},\n\thandler: async (ctx, args) => {\n\t\tconst key = await ctx.db\n\t\t\t.query(\"wrappedKeys\")\n\t\t\t.withIndex(\"by_device\", q =>\n\t\t\t\tq.eq(\"collection\", args.collection).eq(\"userId\", args.userId).eq(\"deviceId\", args.deviceId),\n\t\t\t)\n\t\t\t.first();\n\n\t\treturn key?.wrappedUmk ?? null;\n\t},\n});\n\nexport const storeDocKey = mutation({\n\targs: {\n\t\tcollection: v.string(),\n\t\tdocument: v.string(),\n\t\tuserId: v.string(),\n\t\twrappedKey: v.bytes(),\n\t},\n\thandler: async (ctx, args) => {\n\t\tconst existing = await ctx.db\n\t\t\t.query(\"docKeys\")\n\t\t\t.withIndex(\"by_user_doc\", q =>\n\t\t\t\tq.eq(\"collection\", args.collection).eq(\"userId\", args.userId).eq(\"document\", args.document),\n\t\t\t)\n\t\t\t.first();\n\n\t\tif (existing) {\n\t\t\tawait ctx.db.patch(existing._id, { wrappedKey: args.wrappedKey });\n\t\t\treturn { id: existing._id };\n\t\t}\n\n\t\tconst id = await ctx.db.insert(\"docKeys\", {\n\t\t\tcollection: args.collection,\n\t\t\tdocument: args.document,\n\t\t\tuserId: args.userId,\n\t\t\twrappedKey: args.wrappedKey,\n\t\t\tcreated: Date.now(),\n\t\t});\n\n\t\treturn { id };\n\t},\n});\n\nexport const getDocKey = query({\n\targs: {\n\t\tcollection: v.string(),\n\t\tdocument: v.string(),\n\t\tuserId: v.string(),\n\t},\n\thandler: async (ctx, args) => {\n\t\tconst key = await ctx.db\n\t\t\t.query(\"docKeys\")\n\t\t\t.withIndex(\"by_user_doc\", q =>\n\t\t\t\tq.eq(\"collection\", args.collection).eq(\"userId\", args.userId).eq(\"document\", args.document),\n\t\t\t)\n\t\t\t.first();\n\n\t\treturn key?.wrappedKey ?? null;\n\t},\n});\n\nexport const getDocKeysForUser = query({\n\targs: {\n\t\tcollection: v.string(),\n\t\tuserId: v.string(),\n\t},\n\thandler: async (ctx, args) => {\n\t\treturn ctx.db\n\t\t\t.query(\"docKeys\")\n\t\t\t.withIndex(\"by_user_doc\", q => q.eq(\"collection\", args.collection).eq(\"userId\", args.userId))\n\t\t\t.collect();\n\t},\n});\n"],"mappings":"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"}
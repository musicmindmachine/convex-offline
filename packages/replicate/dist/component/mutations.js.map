{"version":3,"file":"mutations.js","names":["updates: Record<string, unknown>","updates: Uint8Array[]","sessions","query"],"sources":["../../src/component/mutations.ts"],"sourcesContent":["import * as Y from \"yjs\";\nimport { v } from \"convex/values\";\nimport { mutation, query } from \"$/component/_generated/server\";\nimport { api } from \"$/component/_generated/api\";\nimport { getLogger } from \"$/shared/logger\";\nimport { OperationType } from \"$/shared\";\nimport {\n\tprofileValidator,\n\tcursorValidator,\n\tstreamResultValidator,\n\tsessionValidator,\n\tpresenceActionValidator,\n\tsuccessSeqValidator,\n\tcompactResultValidator,\n\trecoveryResultValidator,\n\tdocumentStateValidator,\n} from \"$/shared\";\n\nexport { OperationType };\n\nconst DEFAULT_THRESHOLD = 500;\nconst DEFAULT_TIMEOUT = 24 * 60 * 60 * 1000;\nconst MAX_RETRIES = 3;\n\nasync function getNextSeq(ctx: any, collection: string): Promise<number> {\n\tconst latest = await ctx.db\n\t\t.query(\"deltas\")\n\t\t.withIndex(\"by_seq\", (q: any) => q.eq(\"collection\", collection))\n\t\t.order(\"desc\")\n\t\t.first();\n\treturn (latest?.seq ?? 0) + 1;\n}\n\n// O(1) delta count increment - called when inserting a delta\nasync function incrementDeltaCount(\n\tctx: any,\n\tcollection: string,\n\tdocument: string,\n): Promise<number> {\n\tconst existing = await ctx.db\n\t\t.query(\"deltaCounts\")\n\t\t.withIndex(\"by_document\", (q: any) => q.eq(\"collection\", collection).eq(\"document\", document))\n\t\t.first();\n\n\tif (existing) {\n\t\tconst newCount = existing.count + 1;\n\t\tawait ctx.db.patch(existing._id, { count: newCount });\n\t\treturn newCount;\n\t}\n\n\tawait ctx.db.insert(\"deltaCounts\", { collection, document, count: 1 });\n\treturn 1;\n}\n\n// O(1) delta count decrement - called when compaction deletes deltas\nasync function decrementDeltaCount(\n\tctx: any,\n\tcollection: string,\n\tdocument: string,\n\tamount: number,\n): Promise<void> {\n\tconst existing = await ctx.db\n\t\t.query(\"deltaCounts\")\n\t\t.withIndex(\"by_document\", (q: any) => q.eq(\"collection\", collection).eq(\"document\", document))\n\t\t.first();\n\n\tif (existing) {\n\t\tconst newCount = Math.max(0, existing.count - amount);\n\t\tawait ctx.db.patch(existing._id, { count: newCount });\n\t}\n}\n\n// O(1) compaction threshold check using cached count\nasync function scheduleCompactionIfNeeded(\n\tctx: any,\n\tcollection: string,\n\tdocument: string,\n\tcurrentCount: number,\n\tthreshold: number = DEFAULT_THRESHOLD,\n\ttimeout: number = DEFAULT_TIMEOUT,\n\tretain: number = 0,\n): Promise<void> {\n\tif (currentCount >= threshold) {\n\t\tawait ctx.runMutation(api.mutations.scheduleCompaction, {\n\t\t\tcollection,\n\t\t\tdocument,\n\t\t\ttimeout,\n\t\t\tretain,\n\t\t});\n\t}\n}\n\nexport const insertDocument = mutation({\n\targs: {\n\t\tcollection: v.string(),\n\t\tdocument: v.string(),\n\t\tbytes: v.bytes(),\n\t\tthreshold: v.optional(v.number()),\n\t\ttimeout: v.optional(v.number()),\n\t\tretain: v.optional(v.number()),\n\t},\n\treturns: successSeqValidator,\n\thandler: async (ctx, args) => {\n\t\tconst seq = await getNextSeq(ctx, args.collection);\n\n\t\tawait ctx.db.insert(\"deltas\", {\n\t\t\tcollection: args.collection,\n\t\t\tdocument: args.document,\n\t\t\tbytes: args.bytes,\n\t\t\tseq,\n\t\t});\n\n\t\t// O(1) count increment and compaction check\n\t\tconst count = await incrementDeltaCount(ctx, args.collection, args.document);\n\t\tawait scheduleCompactionIfNeeded(\n\t\t\tctx,\n\t\t\targs.collection,\n\t\t\targs.document,\n\t\t\tcount,\n\t\t\targs.threshold ?? DEFAULT_THRESHOLD,\n\t\t\targs.timeout ?? DEFAULT_TIMEOUT,\n\t\t\targs.retain ?? 0,\n\t\t);\n\n\t\treturn { success: true, seq };\n\t},\n});\n\nexport const updateDocument = mutation({\n\targs: {\n\t\tcollection: v.string(),\n\t\tdocument: v.string(),\n\t\tbytes: v.bytes(),\n\t\tthreshold: v.optional(v.number()),\n\t\ttimeout: v.optional(v.number()),\n\t\tretain: v.optional(v.number()),\n\t},\n\treturns: successSeqValidator,\n\thandler: async (ctx, args) => {\n\t\tconst seq = await getNextSeq(ctx, args.collection);\n\n\t\tawait ctx.db.insert(\"deltas\", {\n\t\t\tcollection: args.collection,\n\t\t\tdocument: args.document,\n\t\t\tbytes: args.bytes,\n\t\t\tseq,\n\t\t});\n\n\t\t// O(1) count increment and compaction check\n\t\tconst count = await incrementDeltaCount(ctx, args.collection, args.document);\n\t\tawait scheduleCompactionIfNeeded(\n\t\t\tctx,\n\t\t\targs.collection,\n\t\t\targs.document,\n\t\t\tcount,\n\t\t\targs.threshold ?? DEFAULT_THRESHOLD,\n\t\t\targs.timeout ?? DEFAULT_TIMEOUT,\n\t\t\targs.retain ?? 0,\n\t\t);\n\n\t\treturn { success: true, seq };\n\t},\n});\n\nexport const deleteDocument = mutation({\n\targs: {\n\t\tcollection: v.string(),\n\t\tdocument: v.string(),\n\t\tbytes: v.bytes(),\n\t\tthreshold: v.optional(v.number()),\n\t\ttimeout: v.optional(v.number()),\n\t\tretain: v.optional(v.number()),\n\t},\n\treturns: successSeqValidator,\n\thandler: async (ctx, args) => {\n\t\tconst seq = await getNextSeq(ctx, args.collection);\n\n\t\tawait ctx.db.insert(\"deltas\", {\n\t\t\tcollection: args.collection,\n\t\t\tdocument: args.document,\n\t\t\tbytes: args.bytes,\n\t\t\tseq,\n\t\t});\n\n\t\t// O(1) count increment and compaction check\n\t\tconst count = await incrementDeltaCount(ctx, args.collection, args.document);\n\t\tawait scheduleCompactionIfNeeded(\n\t\t\tctx,\n\t\t\targs.collection,\n\t\t\targs.document,\n\t\t\tcount,\n\t\t\targs.threshold ?? DEFAULT_THRESHOLD,\n\t\t\targs.timeout ?? DEFAULT_TIMEOUT,\n\t\t\targs.retain ?? 0,\n\t\t);\n\n\t\treturn { success: true, seq };\n\t},\n});\n\nconst DEFAULT_HEARTBEAT_INTERVAL = 10000;\n\nexport const mark = mutation({\n\targs: {\n\t\tcollection: v.string(),\n\t\tdocument: v.string(),\n\t\tclient: v.string(),\n\t\tvector: v.optional(v.bytes()),\n\t\tseq: v.optional(v.number()),\n\t},\n\treturns: v.null(),\n\thandler: async (ctx, args) => {\n\t\tconst now = Date.now();\n\n\t\tconst existing = await ctx.db\n\t\t\t.query(\"sessions\")\n\t\t\t.withIndex(\"by_client\", (q: any) =>\n\t\t\t\tq.eq(\"collection\", args.collection).eq(\"document\", args.document).eq(\"client\", args.client),\n\t\t\t)\n\t\t\t.first();\n\n\t\tconst updates: Record<string, unknown> = {\n\t\t\tseen: now,\n\t\t};\n\n\t\tif (args.vector !== undefined) updates.vector = args.vector;\n\t\tif (args.seq !== undefined) {\n\t\t\tupdates.seq = existing ? Math.max(existing.seq, args.seq) : args.seq;\n\t\t}\n\n\t\tif (existing) {\n\t\t\tawait ctx.db.patch(existing._id, updates);\n\t\t} else {\n\t\t\tawait ctx.db.insert(\"sessions\", {\n\t\t\t\tcollection: args.collection,\n\t\t\t\tdocument: args.document,\n\t\t\t\tclient: args.client,\n\t\t\t\tvector: args.vector,\n\t\t\t\tconnected: false,\n\t\t\t\tseq: args.seq ?? 0,\n\t\t\t\tseen: now,\n\t\t\t});\n\t\t}\n\n\t\treturn null;\n\t},\n});\n\nexport const compact = mutation({\n\targs: {\n\t\tcollection: v.string(),\n\t\tdocument: v.string(),\n\t},\n\treturns: compactResultValidator,\n\thandler: async (ctx, args) => {\n\t\tconst logger = getLogger([\"compaction\"]);\n\t\tconst now = Date.now();\n\n\t\tconst deltas = await ctx.db\n\t\t\t.query(\"deltas\")\n\t\t\t.withIndex(\"by_document\", (q: any) =>\n\t\t\t\tq.eq(\"collection\", args.collection).eq(\"document\", args.document),\n\t\t\t)\n\t\t\t.collect();\n\n\t\tif (deltas.length === 0) {\n\t\t\treturn { success: true, removed: 0, retained: 0, size: 0 };\n\t\t}\n\n\t\tconst existing = await ctx.db\n\t\t\t.query(\"snapshots\")\n\t\t\t.withIndex(\"by_document\", (q: any) =>\n\t\t\t\tq.eq(\"collection\", args.collection).eq(\"document\", args.document),\n\t\t\t)\n\t\t\t.first();\n\n\t\tconst updates: Uint8Array[] = [];\n\t\tif (existing) {\n\t\t\tupdates.push(new Uint8Array(existing.bytes));\n\t\t}\n\t\tupdates.push(...deltas.map((d: any) => new Uint8Array(d.bytes)));\n\n\t\tconst merged = Y.mergeUpdatesV2(updates);\n\t\tconst vector = Y.encodeStateVectorFromUpdateV2(merged);\n\n\t\tconst sessions = await ctx.db\n\t\t\t.query(\"sessions\")\n\t\t\t.withIndex(\"by_document\", (q: any) =>\n\t\t\t\tq.eq(\"collection\", args.collection).eq(\"document\", args.document),\n\t\t\t)\n\t\t\t.filter((q: any) => q.eq(q.field(\"connected\"), true))\n\t\t\t.collect();\n\n\t\tlet canDeleteAll = true;\n\t\tfor (const session of sessions) {\n\t\t\tif (!session.vector) {\n\t\t\t\tcanDeleteAll = false;\n\t\t\t\tlogger.warn(\"Session without vector, skipping full compaction\", {\n\t\t\t\t\tclient: session.client,\n\t\t\t\t});\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tconst sessionVector = new Uint8Array(session.vector);\n\t\t\tconst missing = Y.diffUpdateV2(merged, sessionVector);\n\n\t\t\tif (missing.byteLength > 2) {\n\t\t\t\tcanDeleteAll = false;\n\t\t\t\tlogger.debug(\"Session still needs data\", {\n\t\t\t\t\tclient: session.client,\n\t\t\t\t\tmissingSize: missing.byteLength,\n\t\t\t\t});\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tconst seq = Math.max(...deltas.map((d: any) => d.seq));\n\n\t\tif (existing) {\n\t\t\tawait ctx.db.patch(existing._id, {\n\t\t\t\tbytes: merged.buffer as ArrayBuffer,\n\t\t\t\tvector: vector.buffer as ArrayBuffer,\n\t\t\t\tseq,\n\t\t\t\tcreated: now,\n\t\t\t});\n\t\t} else {\n\t\t\tawait ctx.db.insert(\"snapshots\", {\n\t\t\t\tcollection: args.collection,\n\t\t\t\tdocument: args.document,\n\t\t\t\tbytes: merged.buffer as ArrayBuffer,\n\t\t\t\tvector: vector.buffer as ArrayBuffer,\n\t\t\t\tseq,\n\t\t\t\tcreated: now,\n\t\t\t});\n\t\t}\n\n\t\tlet removed = 0;\n\t\tif (canDeleteAll) {\n\t\t\tfor (const delta of deltas) {\n\t\t\t\tawait ctx.db.delete(delta._id);\n\t\t\t\tremoved++;\n\t\t\t}\n\n\t\t\t// Decrement delta count to keep it in sync\n\t\t\tif (removed > 0) {\n\t\t\t\tawait decrementDeltaCount(ctx, args.collection, args.document, removed);\n\t\t\t}\n\n\t\t\tlogger.info(\"Full compaction completed\", {\n\t\t\t\tdocument: args.document,\n\t\t\t\tremoved,\n\t\t\t\tsize: merged.byteLength,\n\t\t\t});\n\t\t} else {\n\t\t\tlogger.info(\"Snapshot created, deltas retained (clients still syncing)\", {\n\t\t\t\tdocument: args.document,\n\t\t\t\tdeltaCount: deltas.length,\n\t\t\t\tactiveCount: sessions.length,\n\t\t\t});\n\t\t}\n\n\t\tconst disconnected = await ctx.db\n\t\t\t.query(\"sessions\")\n\t\t\t.withIndex(\"by_document\", (q: any) =>\n\t\t\t\tq.eq(\"collection\", args.collection).eq(\"document\", args.document),\n\t\t\t)\n\t\t\t.filter((q: any) => q.eq(q.field(\"connected\"), false))\n\t\t\t.collect();\n\n\t\tlet cleaned = 0;\n\t\tfor (const session of disconnected) {\n\t\t\tif (!session.vector) {\n\t\t\t\tawait ctx.db.delete(session._id);\n\t\t\t\tcleaned++;\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tconst sessionVector = new Uint8Array(session.vector);\n\t\t\tconst missing = Y.diffUpdateV2(merged, sessionVector);\n\n\t\t\tif (missing.byteLength <= 2) {\n\t\t\t\tawait ctx.db.delete(session._id);\n\t\t\t\tcleaned++;\n\t\t\t}\n\t\t}\n\n\t\tif (cleaned > 0) {\n\t\t\tlogger.info(\"Cleaned up disconnected sessions\", {\n\t\t\t\tdocument: args.document,\n\t\t\t\tcleaned,\n\t\t\t});\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tremoved,\n\t\t\tretained: deltas.length - removed,\n\t\t\tsize: merged.byteLength,\n\t\t};\n\t},\n});\n\nexport const scheduleCompaction = mutation({\n\targs: {\n\t\tcollection: v.string(),\n\t\tdocument: v.string(),\n\t\ttimeout: v.optional(v.number()),\n\t\tretain: v.optional(v.number()),\n\t},\n\treturns: v.object({\n\t\tid: v.optional(v.id(\"compaction\")),\n\t\tstatus: v.union(\n\t\t\tv.literal(\"scheduled\"),\n\t\t\tv.literal(\"already_running\"),\n\t\t\tv.literal(\"already_pending\"),\n\t\t),\n\t}),\n\thandler: async (ctx, args) => {\n\t\tconst existing = await ctx.db\n\t\t\t.query(\"compaction\")\n\t\t\t.withIndex(\"by_document\", (q: any) =>\n\t\t\t\tq.eq(\"collection\", args.collection).eq(\"document\", args.document).eq(\"status\", \"running\"),\n\t\t\t)\n\t\t\t.first();\n\n\t\tif (existing) {\n\t\t\treturn { id: existing._id, status: \"already_running\" as const };\n\t\t}\n\n\t\tconst pending = await ctx.db\n\t\t\t.query(\"compaction\")\n\t\t\t.withIndex(\"by_document\", (q: any) =>\n\t\t\t\tq.eq(\"collection\", args.collection).eq(\"document\", args.document).eq(\"status\", \"pending\"),\n\t\t\t)\n\t\t\t.first();\n\n\t\tif (pending) {\n\t\t\treturn { id: pending._id, status: \"already_pending\" as const };\n\t\t}\n\n\t\tconst id = await ctx.db.insert(\"compaction\", {\n\t\t\tcollection: args.collection,\n\t\t\tdocument: args.document,\n\t\t\tstatus: \"pending\",\n\t\t\tstarted: Date.now(),\n\t\t\tretries: 0,\n\t\t});\n\n\t\tawait ctx.scheduler.runAfter(0, api.mutations.runCompaction, {\n\t\t\tid,\n\t\t\ttimeout: args.timeout,\n\t\t\tretain: args.retain,\n\t\t});\n\n\t\treturn { id, status: \"scheduled\" as const };\n\t},\n});\n\nexport const runCompaction = mutation({\n\targs: {\n\t\tid: v.id(\"compaction\"),\n\t\ttimeout: v.optional(v.number()),\n\t\tretain: v.optional(v.number()),\n\t},\n\treturns: v.union(v.null(), v.object({ removed: v.number(), retained: v.number() })),\n\thandler: async (ctx, args) => {\n\t\tconst logger = getLogger([\"compaction\"]);\n\t\tconst job = await ctx.db.get(args.id);\n\n\t\tif (!job || job.status === \"done\") {\n\t\t\treturn null;\n\t\t}\n\n\t\tawait ctx.db.patch(args.id, { status: \"running\" });\n\n\t\tconst now = Date.now();\n\t\tconst timeout = args.timeout ?? DEFAULT_TIMEOUT;\n\t\tconst retain = args.retain ?? 0;\n\n\t\ttry {\n\t\t\tconst deltas = await ctx.db\n\t\t\t\t.query(\"deltas\")\n\t\t\t\t.withIndex(\"by_document\", (q: any) =>\n\t\t\t\t\tq.eq(\"collection\", job.collection).eq(\"document\", job.document),\n\t\t\t\t)\n\t\t\t\t.collect();\n\n\t\t\tif (deltas.length === 0) {\n\t\t\t\tawait ctx.db.patch(args.id, { status: \"done\", completed: now });\n\t\t\t\treturn { removed: 0, retained: 0 };\n\t\t\t}\n\n\t\t\tconst snapshot = await ctx.db\n\t\t\t\t.query(\"snapshots\")\n\t\t\t\t.withIndex(\"by_document\", (q: any) =>\n\t\t\t\t\tq.eq(\"collection\", job.collection).eq(\"document\", job.document),\n\t\t\t\t)\n\t\t\t\t.first();\n\n\t\t\tconst updates: Uint8Array[] = [];\n\t\t\tif (snapshot) {\n\t\t\t\tupdates.push(new Uint8Array(snapshot.bytes));\n\t\t\t}\n\t\t\tupdates.push(...deltas.map((d: any) => new Uint8Array(d.bytes)));\n\n\t\t\tconst merged = Y.mergeUpdatesV2(updates);\n\t\t\tconst vector = Y.encodeStateVectorFromUpdateV2(merged);\n\n\t\t\tconst sessions = await ctx.db\n\t\t\t\t.query(\"sessions\")\n\t\t\t\t.withIndex(\"by_document\", (q: any) =>\n\t\t\t\t\tq.eq(\"collection\", job.collection).eq(\"document\", job.document),\n\t\t\t\t)\n\t\t\t\t.collect();\n\n\t\t\tlet canDeleteAll = true;\n\t\t\tfor (const session of sessions) {\n\t\t\t\tconst isActive = session.connected || now - session.seen < timeout;\n\t\t\t\tif (!isActive) continue;\n\n\t\t\t\tif (!session.vector) {\n\t\t\t\t\tcanDeleteAll = false;\n\t\t\t\t\tlogger.warn(\"Active session without vector, skipping full compaction\", {\n\t\t\t\t\t\tclient: session.client,\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\tconst sessionVector = new Uint8Array(session.vector);\n\t\t\t\tconst missing = Y.diffUpdateV2(merged, sessionVector);\n\n\t\t\t\tif (missing.byteLength > 2) {\n\t\t\t\t\tcanDeleteAll = false;\n\t\t\t\t\tlogger.debug(\"Active session still needs data\", {\n\t\t\t\t\t\tclient: session.client,\n\t\t\t\t\t\tmissingSize: missing.byteLength,\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst seq = Math.max(...deltas.map((d: any) => d.seq));\n\n\t\t\tif (snapshot) {\n\t\t\t\tawait ctx.db.patch(snapshot._id, {\n\t\t\t\t\tbytes: merged.buffer as ArrayBuffer,\n\t\t\t\t\tvector: vector.buffer as ArrayBuffer,\n\t\t\t\t\tseq,\n\t\t\t\t\tcreated: now,\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tawait ctx.db.insert(\"snapshots\", {\n\t\t\t\t\tcollection: job.collection,\n\t\t\t\t\tdocument: job.document,\n\t\t\t\t\tbytes: merged.buffer as ArrayBuffer,\n\t\t\t\t\tvector: vector.buffer as ArrayBuffer,\n\t\t\t\t\tseq,\n\t\t\t\t\tcreated: now,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tlet removed = 0;\n\t\t\tif (canDeleteAll) {\n\t\t\t\tconst sortedDeltas = [...deltas].sort((a: any, b: any) => b.seq - a.seq);\n\t\t\t\tconst deltasToRetain = sortedDeltas.slice(0, retain);\n\t\t\t\tconst deltasToDelete = sortedDeltas.slice(retain);\n\t\t\t\tconst retainIds = new Set(deltasToRetain.map((d: any) => d._id));\n\n\t\t\t\tfor (const delta of deltasToDelete) {\n\t\t\t\t\tif (!retainIds.has(delta._id)) {\n\t\t\t\t\t\tawait ctx.db.delete(delta._id);\n\t\t\t\t\t\tremoved++;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Decrement delta count to keep it in sync\n\t\t\t\tif (removed > 0) {\n\t\t\t\t\tawait decrementDeltaCount(ctx, job.collection, job.document, removed);\n\t\t\t\t}\n\n\t\t\t\tlogger.info(\"Compaction completed\", {\n\t\t\t\t\tdocument: job.document,\n\t\t\t\t\tremoved,\n\t\t\t\t\tretained: deltasToRetain.length,\n\t\t\t\t\tsize: merged.byteLength,\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tlogger.info(\"Snapshot created, deltas retained (clients still syncing)\", {\n\t\t\t\t\tdocument: job.document,\n\t\t\t\t\tdeltaCount: deltas.length,\n\t\t\t\t\tactiveCount: sessions.filter((s: any) => s.connected || now - s.seen < timeout).length,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tfor (const session of sessions) {\n\t\t\t\tif (session.connected) continue;\n\t\t\t\tif (now - session.seen > timeout) {\n\t\t\t\t\tawait ctx.db.delete(session._id);\n\t\t\t\t\tlogger.debug(\"Cleaned up stale session\", { client: session.client });\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tawait ctx.db.patch(args.id, { status: \"done\", completed: now });\n\t\t\treturn { removed, retained: deltas.length - removed };\n\t\t} catch (error) {\n\t\t\tconst retries = (job.retries ?? 0) + 1;\n\n\t\t\tif (retries < MAX_RETRIES) {\n\t\t\t\tawait ctx.db.patch(args.id, { status: \"pending\", retries });\n\t\t\t\tconst backoff = Math.pow(2, retries) * 1000;\n\t\t\t\tawait ctx.scheduler.runAfter(backoff, api.mutations.runCompaction, {\n\t\t\t\t\tid: args.id,\n\t\t\t\t\ttimeout: args.timeout,\n\t\t\t\t\tretain: args.retain,\n\t\t\t\t});\n\t\t\t\tlogger.warn(\"Compaction failed, scheduling retry\", {\n\t\t\t\t\tdocument: job.document,\n\t\t\t\t\tretries,\n\t\t\t\t\tbackoff,\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tawait ctx.db.patch(args.id, {\n\t\t\t\t\tstatus: \"failed\",\n\t\t\t\t\terror: String(error),\n\t\t\t\t\tcompleted: now,\n\t\t\t\t});\n\t\t\t\tlogger.error(\"Compaction failed after max retries\", {\n\t\t\t\t\tdocument: job.document,\n\t\t\t\t\terror: String(error),\n\t\t\t\t});\n\t\t\t}\n\t\t\tthrow error;\n\t\t}\n\t},\n});\n\nexport const stream = query({\n\targs: {\n\t\tcollection: v.string(),\n\t\tseq: v.number(),\n\t\tlimit: v.optional(v.number()),\n\t\tthreshold: v.optional(v.number()),\n\t},\n\treturns: streamResultValidator,\n\thandler: async (ctx, args) => {\n\t\tconst limit = args.limit ?? 100;\n\t\t// threshold arg kept for API compatibility but no longer used\n\t\t// (compaction check moved to write mutations for O(1) performance)\n\n\t\tconst documents = await ctx.db\n\t\t\t.query(\"deltas\")\n\t\t\t.withIndex(\"by_seq\", (q: any) => q.eq(\"collection\", args.collection).gt(\"seq\", args.seq))\n\t\t\t.order(\"asc\")\n\t\t\t.take(limit);\n\n\t\tif (documents.length > 0) {\n\t\t\tconst changes = documents.map((doc: any) => ({\n\t\t\t\tdocument: doc.document,\n\t\t\t\tbytes: doc.bytes,\n\t\t\t\tseq: doc.seq,\n\t\t\t\ttype: OperationType.Delta,\n\t\t\t}));\n\n\t\t\tconst newSeq = documents[documents.length - 1]?.seq ?? args.seq;\n\n\t\t\t// Compaction eligibility is now checked only during write mutations\n\t\t\t// (insertDocument, updateDocument, deleteDocument) via scheduleCompactionIfNeeded.\n\t\t\t// This removes the O(n) full collection scan that was running on every subscription update.\n\n\t\t\treturn {\n\t\t\t\tchanges,\n\t\t\t\tseq: newSeq,\n\t\t\t\tmore: documents.length === limit,\n\t\t\t\tcompact: undefined,\n\t\t\t};\n\t\t}\n\n\t\tconst oldest = await ctx.db\n\t\t\t.query(\"deltas\")\n\t\t\t.withIndex(\"by_seq\", (q: any) => q.eq(\"collection\", args.collection))\n\t\t\t.order(\"asc\")\n\t\t\t.first();\n\n\t\tif (oldest && args.seq < oldest.seq) {\n\t\t\tconst snapshots = await ctx.db\n\t\t\t\t.query(\"snapshots\")\n\t\t\t\t.withIndex(\"by_document\", (q: any) => q.eq(\"collection\", args.collection))\n\t\t\t\t.collect();\n\n\t\t\tif (snapshots.length === 0) {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t`Disparity detected but no snapshots available for collection: ${args.collection}. ` +\n\t\t\t\t\t\t`Client seq: ${args.seq}, Oldest delta seq: ${oldest.seq}`,\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tconst changes = snapshots.map((s: any) => ({\n\t\t\t\tdocument: s.document,\n\t\t\t\tbytes: s.bytes,\n\t\t\t\tseq: s.seq,\n\t\t\t\ttype: OperationType.Snapshot,\n\t\t\t}));\n\n\t\t\tconst latestSeq = Math.max(...snapshots.map((s: any) => s.seq));\n\n\t\t\treturn {\n\t\t\t\tchanges,\n\t\t\t\tseq: latestSeq,\n\t\t\t\tmore: false,\n\t\t\t\tcompact: undefined,\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\tchanges: [],\n\t\t\tseq: args.seq,\n\t\t\tmore: false,\n\t\t\tcompact: undefined,\n\t\t};\n\t},\n});\n\nexport const recovery = query({\n\targs: {\n\t\tcollection: v.string(),\n\t\tdocument: v.string(),\n\t\tvector: v.bytes(),\n\t},\n\treturns: recoveryResultValidator,\n\thandler: async (ctx, args) => {\n\t\tconst snapshot = await ctx.db\n\t\t\t.query(\"snapshots\")\n\t\t\t.withIndex(\"by_document\", (q: any) =>\n\t\t\t\tq.eq(\"collection\", args.collection).eq(\"document\", args.document),\n\t\t\t)\n\t\t\t.first();\n\n\t\tconst deltas = await ctx.db\n\t\t\t.query(\"deltas\")\n\t\t\t.withIndex(\"by_document\", (q: any) =>\n\t\t\t\tq.eq(\"collection\", args.collection).eq(\"document\", args.document),\n\t\t\t)\n\t\t\t.collect();\n\n\t\tif (!snapshot && deltas.length === 0) {\n\t\t\tconst emptyDoc = new Y.Doc();\n\t\t\tconst emptyVector = Y.encodeStateVector(emptyDoc);\n\t\t\temptyDoc.destroy();\n\t\t\treturn {\n\t\t\t\tvector: emptyVector.buffer as ArrayBuffer,\n\t\t\t};\n\t\t}\n\n\t\tconst updates: Uint8Array[] = [];\n\n\t\tif (snapshot) {\n\t\t\tupdates.push(new Uint8Array(snapshot.bytes));\n\t\t}\n\n\t\tfor (const delta of deltas) {\n\t\t\tupdates.push(new Uint8Array(delta.bytes));\n\t\t}\n\n\t\tconst merged = Y.mergeUpdatesV2(updates);\n\t\tconst clientVector = new Uint8Array(args.vector);\n\t\tconst diff = Y.diffUpdateV2(merged, clientVector);\n\t\tconst serverVector = Y.encodeStateVectorFromUpdateV2(merged);\n\n\t\treturn {\n\t\t\tdiff: diff.byteLength > 0 ? (diff.buffer as ArrayBuffer) : undefined,\n\t\t\tvector: serverVector.buffer as ArrayBuffer,\n\t\t};\n\t},\n});\n\nexport const getDocumentState = query({\n\targs: {\n\t\tcollection: v.string(),\n\t\tdocument: v.string(),\n\t},\n\treturns: documentStateValidator,\n\thandler: async (ctx, args) => {\n\t\tconst snapshot = await ctx.db\n\t\t\t.query(\"snapshots\")\n\t\t\t.withIndex(\"by_document\", (q: any) =>\n\t\t\t\tq.eq(\"collection\", args.collection).eq(\"document\", args.document),\n\t\t\t)\n\t\t\t.first();\n\n\t\tconst deltas = await ctx.db\n\t\t\t.query(\"deltas\")\n\t\t\t.withIndex(\"by_document\", (q: any) =>\n\t\t\t\tq.eq(\"collection\", args.collection).eq(\"document\", args.document),\n\t\t\t)\n\t\t\t.collect();\n\n\t\tif (!snapshot && deltas.length === 0) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst updates: Uint8Array[] = [];\n\t\tlet latestSeq = 0;\n\n\t\tif (snapshot) {\n\t\t\tupdates.push(new Uint8Array(snapshot.bytes));\n\t\t\tlatestSeq = Math.max(latestSeq, snapshot.seq);\n\t\t}\n\n\t\tfor (const delta of deltas) {\n\t\t\tupdates.push(new Uint8Array(delta.bytes));\n\t\t\tlatestSeq = Math.max(latestSeq, delta.seq);\n\t\t}\n\n\t\tconst merged = Y.mergeUpdatesV2(updates);\n\n\t\treturn {\n\t\t\tbytes: merged.buffer as ArrayBuffer,\n\t\t\tseq: latestSeq,\n\t\t};\n\t},\n});\n\nexport const sessions = query({\n\targs: {\n\t\tcollection: v.string(),\n\t\tdocument: v.string(),\n\t\tconnected: v.optional(v.boolean()),\n\t\texclude: v.optional(v.string()),\n\t},\n\treturns: v.array(sessionValidator),\n\thandler: async (ctx, args) => {\n\t\tlet query = ctx.db\n\t\t\t.query(\"sessions\")\n\t\t\t.withIndex(\"by_document\", (q: any) =>\n\t\t\t\tq.eq(\"collection\", args.collection).eq(\"document\", args.document),\n\t\t\t);\n\n\t\tif (args.connected !== undefined) {\n\t\t\tquery = query.filter((q: any) => q.eq(q.field(\"connected\"), args.connected));\n\t\t}\n\n\t\tconst records = await query.collect();\n\n\t\tconst mapped = records\n\t\t\t.filter((p: any) => !args.exclude || p.client !== args.exclude)\n\t\t\t.map((p: any) => ({\n\t\t\t\tclient: p.client,\n\t\t\t\tdocument: p.document,\n\t\t\t\tuser: p.user,\n\t\t\t\tprofile: p.profile,\n\t\t\t\tcursor: p.cursor,\n\t\t\t\tseen: p.seen,\n\t\t\t}));\n\n\t\tconst byUser = new Map<string, (typeof mapped)[0]>();\n\t\tfor (const p of mapped) {\n\t\t\tconst key = p.user ?? p.client;\n\t\t\tconst existing = byUser.get(key);\n\t\t\tif (!existing || p.seen > existing.seen) {\n\t\t\t\tbyUser.set(key, p);\n\t\t\t}\n\t\t}\n\n\t\treturn Array.from(byUser.values());\n\t},\n});\n\nexport const disconnect = mutation({\n\targs: {\n\t\tcollection: v.string(),\n\t\tdocument: v.string(),\n\t\tclient: v.string(),\n\t},\n\treturns: v.null(),\n\thandler: async (ctx, args) => {\n\t\tconst existing = await ctx.db\n\t\t\t.query(\"sessions\")\n\t\t\t.withIndex(\"by_client\", (q: any) =>\n\t\t\t\tq.eq(\"collection\", args.collection).eq(\"document\", args.document).eq(\"client\", args.client),\n\t\t\t)\n\t\t\t.first();\n\n\t\tif (existing) {\n\t\t\tawait ctx.db.patch(existing._id, {\n\t\t\t\tconnected: false,\n\t\t\t\tcursor: undefined,\n\t\t\t\ttimeout: undefined,\n\t\t\t});\n\t\t}\n\n\t\treturn null;\n\t},\n});\n\nexport const presence = mutation({\n\targs: {\n\t\tcollection: v.string(),\n\t\tdocument: v.string(),\n\t\tclient: v.string(),\n\t\taction: presenceActionValidator,\n\t\tuser: v.optional(v.string()),\n\t\tprofile: v.optional(profileValidator),\n\t\tcursor: v.optional(cursorValidator),\n\t\tinterval: v.optional(v.number()),\n\t\tvector: v.optional(v.bytes()),\n\t},\n\treturns: v.null(),\n\thandler: async (ctx, args) => {\n\t\tconst existing = await ctx.db\n\t\t\t.query(\"sessions\")\n\t\t\t.withIndex(\"by_client\", (q: any) =>\n\t\t\t\tq.eq(\"collection\", args.collection).eq(\"document\", args.document).eq(\"client\", args.client),\n\t\t\t)\n\t\t\t.first();\n\n\t\tif (args.action === \"leave\") {\n\t\t\tif (existing?.timeout) {\n\t\t\t\tawait ctx.scheduler.cancel(existing.timeout);\n\t\t\t}\n\t\t\tif (existing) {\n\t\t\t\tawait ctx.db.patch(existing._id, {\n\t\t\t\t\tconnected: false,\n\t\t\t\t\tcursor: undefined,\n\t\t\t\t\ttimeout: undefined,\n\t\t\t\t});\n\t\t\t}\n\t\t\treturn null;\n\t\t}\n\n\t\tconst now = Date.now();\n\t\tconst interval = args.interval ?? DEFAULT_HEARTBEAT_INTERVAL;\n\n\t\tif (existing?.timeout) {\n\t\t\tawait ctx.scheduler.cancel(existing.timeout);\n\t\t}\n\n\t\tconst timeout = await ctx.scheduler.runAfter(interval * 2.5, api.mutations.disconnect, {\n\t\t\tcollection: args.collection,\n\t\t\tdocument: args.document,\n\t\t\tclient: args.client,\n\t\t});\n\n\t\tconst updates: Record<string, unknown> = {\n\t\t\tconnected: true,\n\t\t\tseen: now,\n\t\t\ttimeout,\n\t\t};\n\n\t\tif (args.user !== undefined) updates.user = args.user;\n\t\tif (args.profile !== undefined) updates.profile = args.profile;\n\t\tif (args.cursor !== undefined) updates.cursor = args.cursor;\n\t\tif (args.vector !== undefined) updates.vector = args.vector;\n\n\t\tif (existing) {\n\t\t\tawait ctx.db.patch(existing._id, updates);\n\t\t} else {\n\t\t\tawait ctx.db.insert(\"sessions\", {\n\t\t\t\tcollection: args.collection,\n\t\t\t\tdocument: args.document,\n\t\t\t\tclient: args.client,\n\t\t\t\tconnected: true,\n\t\t\t\tseq: 0,\n\t\t\t\tseen: now,\n\t\t\t\tuser: args.user,\n\t\t\t\tprofile: args.profile,\n\t\t\t\tcursor: args.cursor,\n\t\t\t\tvector: args.vector,\n\t\t\t\ttimeout,\n\t\t\t});\n\t\t}\n\n\t\treturn null;\n\t},\n});\n"],"mappings":"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"}
{"version":3,"file":"schema.js","names":[],"sources":["../../src/component/schema.ts"],"sourcesContent":["import { defineSchema, defineTable } from \"convex/server\";\nimport { v } from \"convex/values\";\nimport { profileValidator, cursorValidator } from \"$/shared\";\n\nexport default defineSchema({\n\tdevices: defineTable({\n\t\tcollection: v.string(),\n\t\tuserId: v.string(),\n\t\tdeviceId: v.string(),\n\t\tpublicKey: v.bytes(),\n\t\tname: v.optional(v.string()),\n\t\tcreated: v.number(),\n\t\tlastSeen: v.number(),\n\t\tapproved: v.boolean(),\n\t})\n\t\t.index(\"by_user\", [\"collection\", \"userId\"])\n\t\t.index(\"by_device\", [\"collection\", \"userId\", \"deviceId\"]),\n\n\twrappedKeys: defineTable({\n\t\tcollection: v.string(),\n\t\tuserId: v.string(),\n\t\tdeviceId: v.string(),\n\t\twrappedUmk: v.bytes(),\n\t\tcreated: v.number(),\n\t})\n\t\t.index(\"by_user\", [\"collection\", \"userId\"])\n\t\t.index(\"by_device\", [\"collection\", \"userId\", \"deviceId\"]),\n\n\tdocKeys: defineTable({\n\t\tcollection: v.string(),\n\t\tdocument: v.string(),\n\t\tuserId: v.string(),\n\t\twrappedKey: v.bytes(),\n\t\tcreated: v.number(),\n\t})\n\t\t.index(\"by_document\", [\"collection\", \"document\"])\n\t\t.index(\"by_user_doc\", [\"collection\", \"userId\", \"document\"]),\n\n\tdeltas: defineTable({\n\t\tcollection: v.string(),\n\t\tdocument: v.string(),\n\t\tbytes: v.bytes(),\n\t\tseq: v.number(),\n\t})\n\t\t.index(\"by_collection\", [\"collection\"])\n\t\t.index(\"by_document\", [\"collection\", \"document\"])\n\t\t.index(\"by_seq\", [\"collection\", \"seq\"]),\n\n\t// Tracks delta count per document for O(1) compaction threshold checks\n\tdeltaCounts: defineTable({\n\t\tcollection: v.string(),\n\t\tdocument: v.string(),\n\t\tcount: v.number(),\n\t}).index(\"by_document\", [\"collection\", \"document\"]),\n\n\tsnapshots: defineTable({\n\t\tcollection: v.string(),\n\t\tdocument: v.string(),\n\t\tbytes: v.bytes(),\n\t\tvector: v.bytes(),\n\t\tseq: v.number(),\n\t\tcreated: v.number(),\n\t}).index(\"by_document\", [\"collection\", \"document\"]),\n\n\tsessions: defineTable({\n\t\tcollection: v.string(),\n\t\tdocument: v.string(),\n\t\tclient: v.string(),\n\t\tvector: v.optional(v.bytes()),\n\t\tconnected: v.boolean(),\n\t\tseq: v.number(),\n\t\tseen: v.number(),\n\t\tuser: v.optional(v.string()),\n\t\tprofile: v.optional(profileValidator),\n\t\tcursor: v.optional(cursorValidator),\n\t\ttimeout: v.optional(v.id(\"_scheduled_functions\")),\n\t})\n\t\t.index(\"by_collection\", [\"collection\"])\n\t\t.index(\"by_document\", [\"collection\", \"document\"])\n\t\t.index(\"by_client\", [\"collection\", \"document\", \"client\"])\n\t\t.index(\"by_connected\", [\"collection\", \"document\", \"connected\"]),\n\n\tcompaction: defineTable({\n\t\tcollection: v.string(),\n\t\tdocument: v.string(),\n\t\tstatus: v.union(\n\t\t\tv.literal(\"pending\"),\n\t\t\tv.literal(\"running\"),\n\t\t\tv.literal(\"done\"),\n\t\t\tv.literal(\"failed\"),\n\t\t),\n\t\tstarted: v.number(),\n\t\tcompleted: v.optional(v.number()),\n\t\tretries: v.number(),\n\t\ttimeout: v.optional(v.number()),\n\t\terror: v.optional(v.string()),\n\t})\n\t\t.index(\"by_document\", [\"collection\", \"document\", \"status\"])\n\t\t.index(\"by_status\", [\"status\", \"started\"]),\n});\n"],"mappings":"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"}
{"version":3,"file":"index.js","names":[],"sources":["../../../src/shared/index.ts"],"sourcesContent":["/**\n * @trestleinc/replicate - Shared Module\n *\n * Single source of truth for all validators, types, and utilities.\n *\n * Following the val.md pattern:\n * 1. All validators defined here\n * 2. Types derived from validators using Infer<>\n * 3. No duplicate interfaces - types come from validators\n */\n\nimport { type Infer, v } from \"convex/values\";\n\n// ============================================================================\n// Core Validators (used across component, server, client)\n// ============================================================================\n\n/**\n * Profile validator for user presence/identity.\n * Used in sessions and presence tracking.\n */\nexport const profileValidator = v.object({\n\tname: v.optional(v.string()),\n\tcolor: v.optional(v.string()),\n\tavatar: v.optional(v.string()),\n});\n\n/**\n * Cursor validator for collaborative editing positions.\n * Tracks anchor/head selection positions and optional field context.\n */\nexport const cursorValidator = v.object({\n\tanchor: v.any(),\n\thead: v.any(),\n\tfield: v.optional(v.string()),\n});\n\n/**\n * Prose validator for ProseMirror-compatible rich text JSON.\n * Used for collaborative rich text editing fields.\n */\nexport const proseValidator = v.object({\n\ttype: v.literal(\"doc\"),\n\tcontent: v.optional(v.array(v.any())),\n});\n\n// ============================================================================\n// Stream/Sync Validators\n// ============================================================================\n\n/**\n * Individual change in a stream response.\n */\nexport const streamChangeValidator = v.object({\n\tdocument: v.string(),\n\tbytes: v.bytes(),\n\tseq: v.number(),\n\ttype: v.string(),\n});\n\n/**\n * Extended stream change with existence flag (used in server responses).\n */\nexport const streamChangeWithExistsValidator = v.object({\n\tdocument: v.string(),\n\tbytes: v.bytes(),\n\tseq: v.number(),\n\ttype: v.string(),\n\texists: v.boolean(),\n});\n\n/**\n * Stream query result with changes, cursor, and compaction hints.\n */\nexport const streamResultValidator = v.object({\n\tchanges: v.array(streamChangeValidator),\n\tseq: v.number(),\n\tmore: v.boolean(),\n\tcompact: v.optional(\n\t\tv.object({\n\t\t\tdocuments: v.array(v.string()),\n\t\t}),\n\t),\n});\n\n/**\n * Stream result with exists flag on changes (server-enriched response).\n */\nexport const streamResultWithExistsValidator = v.object({\n\tchanges: v.array(streamChangeWithExistsValidator),\n\tseq: v.number(),\n\tmore: v.boolean(),\n\tcompact: v.optional(\n\t\tv.object({\n\t\t\tdocuments: v.array(v.string()),\n\t\t}),\n\t),\n});\n\n// ============================================================================\n// Session/Presence Validators\n// ============================================================================\n\n/**\n * Session record for presence tracking.\n * Returned by sessions query.\n */\nexport const sessionValidator = v.object({\n\tclient: v.string(),\n\tdocument: v.string(),\n\tuser: v.optional(v.string()),\n\tprofile: v.optional(v.any()),\n\tcursor: v.optional(cursorValidator),\n\tseen: v.number(),\n});\n\n/**\n * Presence action (join or leave).\n * @deprecated Use sessionActionValidator instead\n */\nexport const presenceActionValidator = v.union(v.literal(\"join\"), v.literal(\"leave\"));\n\n// ============================================================================\n// New API Validators (Phase 1: signals.md migration)\n// ============================================================================\n\n/**\n * Replicate mutation type - combines insert/update/delete.\n */\nexport const replicateTypeValidator = v.union(\n\tv.literal(\"insert\"),\n\tv.literal(\"update\"),\n\tv.literal(\"delete\"),\n);\n\n/**\n * Session action - combines presence (join/leave) and mark (mark/signal).\n */\nexport const sessionActionValidator = v.union(\n\tv.literal(\"join\"),\n\tv.literal(\"leave\"),\n\tv.literal(\"mark\"),\n\tv.literal(\"signal\"),\n);\n\n// ============================================================================\n// Mutation Result Validators\n// ============================================================================\n\n/**\n * Standard success/seq result for insert/update/delete mutations.\n */\nexport const successSeqValidator = v.object({\n\tsuccess: v.boolean(),\n\tseq: v.number(),\n});\n\n/**\n * Compaction result with statistics.\n */\nexport const compactResultValidator = v.object({\n\tsuccess: v.boolean(),\n\tremoved: v.number(),\n\tretained: v.number(),\n\tsize: v.number(),\n});\n\n/**\n * Recovery query result with optional diff and state vector.\n */\nexport const recoveryResultValidator = v.object({\n\tdiff: v.optional(v.bytes()),\n\tvector: v.bytes(),\n});\n\n/**\n * Document state result (for SSR/hydration).\n */\nexport const documentStateValidator = v.union(\n\tv.object({\n\t\tbytes: v.bytes(),\n\t\tseq: v.number(),\n\t}),\n\tv.null(),\n);\n\n// ============================================================================\n// SSR/Material Validators\n// ============================================================================\n\n/**\n * SSR material query result (non-paginated, backward compatible).\n */\nexport const materialResultValidator = v.object({\n\tdocuments: v.any(),\n\tcount: v.number(),\n\tcrdt: v.optional(\n\t\tv.record(\n\t\t\tv.string(),\n\t\t\tv.object({\n\t\t\t\tbytes: v.bytes(),\n\t\t\t\tseq: v.number(),\n\t\t\t}),\n\t\t),\n\t),\n\tcursor: v.optional(v.number()),\n});\n\n// ============================================================================\n// Derived Types (Single Source of Truth)\n// ============================================================================\n\n/** User profile for presence/identity. */\nexport type Profile = Infer<typeof profileValidator>;\n\n/** Cursor position for collaborative editing. */\nexport type Cursor = Infer<typeof cursorValidator>;\n\n/** ProseMirror-compatible JSON structure. */\nexport type ProseValue = Infer<typeof proseValidator>;\n\n/** Individual stream change. */\nexport type StreamChange = Infer<typeof streamChangeValidator>;\n\n/** Stream change with exists flag. */\nexport type StreamChangeWithExists = Infer<typeof streamChangeWithExistsValidator>;\n\n/** Stream query result. */\nexport type StreamResult = Infer<typeof streamResultValidator>;\n\n/** Stream result with exists flags. */\nexport type StreamResultWithExists = Infer<typeof streamResultWithExistsValidator>;\n\n/** Session record for presence. */\nexport type Session = Infer<typeof sessionValidator>;\n\n/** Presence action type. */\nexport type PresenceAction = Infer<typeof presenceActionValidator>;\n\n/** Replicate mutation type. */\nexport type ReplicateType = Infer<typeof replicateTypeValidator>;\n\n/** Session action type. */\nexport type SessionAction = Infer<typeof sessionActionValidator>;\n\n/** Success/seq mutation result. */\nexport type SuccessSeq = Infer<typeof successSeqValidator>;\n\n/** Compaction result with stats. */\nexport type CompactResult = Infer<typeof compactResultValidator>;\n\n/** Recovery query result. */\nexport type RecoveryResult = Infer<typeof recoveryResultValidator>;\n\n/** Document state for SSR. */\nexport type DocumentState = Infer<typeof documentStateValidator>;\n\n/** SSR material result. */\nexport type MaterialResult = Infer<typeof materialResultValidator>;\n\n// ============================================================================\n// Additional Types (from types.ts)\n// ============================================================================\n\nexport interface FragmentValue {\n\t__xmlFragment: true;\n\tcontent?: XmlFragmentJSON;\n}\n\nexport interface XmlFragmentJSON {\n\ttype: \"doc\";\n\tcontent?: XmlNodeJSON[];\n}\n\nexport interface XmlNodeJSON {\n\ttype: string;\n\tattrs?: Record<string, unknown>;\n\tcontent?: XmlNodeJSON[];\n\ttext?: string;\n\tmarks?: { type: string; attrs?: Record<string, unknown> }[];\n}\n\n/** Operation type for streaming changes */\nexport enum OperationType {\n\tDelta = \"delta\",\n\tSnapshot = \"snapshot\",\n}\n\n/**\n * Extract prose field names from T (fields typed as ProseValue).\n * Used internally for type-safe prose field operations.\n */\nexport type ProseFields<T> = {\n\t[K in keyof T]: T[K] extends ProseValue ? K : never;\n}[keyof T];\n\n// ============================================================================\n// Duration Utilities\n// ============================================================================\n\ntype DurationUnit = \"m\" | \"h\" | \"d\";\nexport type Duration = `${number}${DurationUnit}`;\n\nexport interface CompactionConfig {\n\tthreshold?: number;\n\ttimeout?: Duration;\n\tretain?: number;\n}\n\nconst DURATION_MULTIPLIERS: Record<DurationUnit, number> = {\n\tm: 60_000,\n\th: 3_600_000,\n\td: 86_400_000,\n};\n\nexport function parseDuration(s: Duration): number {\n\tconst match = /^(\\d+)(m|h|d)$/i.exec(s);\n\tif (!match) throw new Error(`Invalid duration: ${s}`);\n\tconst [, num, unit] = match;\n\treturn parseInt(num) * DURATION_MULTIPLIERS[unit.toLowerCase() as DurationUnit];\n}\n\nexport { getLogger, type Logger } from \"./logger\";\n"],"mappings":"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"}